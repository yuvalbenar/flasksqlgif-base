name: AWS CI/CD Pipeline

on:
  push:
    branches:
      - develop-aws
  pull_request:
    branches:
      - develop-aws

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Add secrets to GITHUB_ENV
        run: |
          echo "DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_ENV
          echo "DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}" >> $GITHUB_ENV

      - name: Build Docker image
        run: |
          docker build -t yuvalbenar/flasksqlgifbase:${{ github.run_number }} .

      - name: Docker login to Docker Hub
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin

      - name: Push Docker image to Docker Hub
        run: |
          docker push yuvalbenar/flasksqlgifbase:${{ github.run_number }}

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install AWS CLI
        run: |
          if ! command -v aws &> /dev/null; then
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip awscliv2.zip
            sudo ./aws/install
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Delete old SSH key pair and create a new one
        run: |
          set -ex
          aws ec2 delete-key-pair --key-name MyDynamicKey || true
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/MyDynamicKey -N ""
          aws ec2 import-key-pair --key-name MyDynamicKey --public-key-material fileb://~/.ssh/MyDynamicKey.pub

      - name: Deploy EC2 instance
        run: |
          set -ex
          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id ami-01816d07b1128cd2d \
            --instance-type t2.micro \
            --key-name MyDynamicKey \
            --security-group-ids sg-0a1c36e26e49cd294 \
            --user-data '#!/bin/bash
            yum update -y
            amazon-linux-extras enable docker
            yum install -y docker
            systemctl start docker
            systemctl enable docker' \
            --query 'Instances[0].InstanceId' \
            --output text)
          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV
          aws ec2 wait instance-status-ok --instance-ids $INSTANCE_ID
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_ID \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV

      - name: SCP project files to EC2 instance
        run: |
          set -ex
          scp -i ~/.ssh/MyDynamicKey -o StrictHostKeyChecking=no -r . ec2-user@${{ env.PUBLIC_IP }}:/home/ec2-user/project

      - name: Run docker-compose on EC2 instance
        run: |
          set -ex
          ssh -i ~/.ssh/MyDynamicKey -o StrictHostKeyChecking=no ec2-user@${{ env.PUBLIC_IP }} << 'EOF'
          # Install Docker Compose
          sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          # Verify docker-compose installation
          docker-compose --version
          # Run docker-compose up
          cd /home/ec2-user/project
          docker-compose up -d
          EOF
